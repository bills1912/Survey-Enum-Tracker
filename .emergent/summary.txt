<analysis>
The user wants to build a comprehensive device tracking application for field data collection. The project began with a request for a Flutter/Firebase stack, which was negotiated to the supported Expo (React Native), FastAPI, and MongoDB stack. The core requirements include real-time location tracking of field enumerators, a map-based visualization of survey respondents with color-coded statuses (pending, in-progress, completed), role-based access control (Admin, Supervisor, Enumerator, Leader), and an AI chat assistant (Gemini).

The development trajectory shows an iterative process. The backend was established first, with a RESTful API using FastAPI and a MongoDB database, including user authentication (JWT), and endpoints for managing users, respondents, surveys, and chat. A seed script was created for initial data population.

The frontend, built with Expo (React Native), has a tab-based navigation structure. Key features implemented include:
- A login screen and authentication flow using React Context.
- Offline-first capabilities, queuing location data and survey submissions for later synchronization.
- A map view that, after several iterations to solve device/Expo Go compatibility issues, now uses Leaflet.js within a  for robust performance. This map supports zooming to locations, displaying routes, and showing the user's current position.
- A feature for enumerators to add new respondents, including capturing location via GPS or by pinning a location on a map.
- A custom, professional-looking logout confirmation modal.
- The initial framework for multi-survey support, including a new screen to list and select surveys.
- Manual data synchronization buttons on the Dashboard and Survey List screens.

The user's primary language is English. The next agent must respond in English.
</analysis>

<product_requirements>
The goal is to create a multi-user, real-time device tracking application for monitoring field data collection activities.

**Core Functionality:**
-   **Mobile App (Android/iOS via Expo):** An application for field officers (Enumerators) and their Supervisors.
-   **Web Dashboard:** A monitoring dashboard for Admins and high-level Leaders.
-   **Role-Based Access:**
    -   **Enumerator:** Views own progress, conducts surveys, uses chat, adds new respondents, and sees their own location track.
    -   **Supervisor:** Monitors their assigned team of enumerators.
    -   **Admin:** Full access to monitor all users and data.
    -   **Leader:** A web-based view to monitor overall progress and locations.

**Key Features Implemented:**
-   **Real-Time Location Tracking:** Tracks enumerator locations every 5 minutes.
-   **Map Visualization:** Uses OpenStreetMap (via Leaflet.js) to display color-coded respondent markers (Red: Pending, Yellow: In-progress, Green: Completed). Users can click a respondent to zoom in or view a route.
-   **Offline First:** The app functions without a network signal. Location data and survey results are stored locally and synced automatically when connectivity is restored.
-   **Multi-Survey Support:** The backend supports multiple surveys, and a survey selection screen has been added for all users.
-   **Manual Sync:** Users can manually trigger data synchronization from the Dashboard and Survey List.
-   **Secure Logout:** A confirmation modal requiring a random code input prevents accidental logouts.
-   **Add Respondent:** Enumerators can add new respondents on the fly, capturing their location via GPS or by pinning it on the map.
</product_requirements>

<key_technical_concepts>
-   **Full-Stack Architecture:** Expo (React Native) frontend, FastAPI (Python) backend, MongoDB database.
-   **Authentication:** JWT-based token authentication.
-   **Mapping:**  embedding Leaflet.js with OpenStreetMap tiles for map display, markers, and routing ().
-   **Location Services:**  for foreground and background GPS tracking.
-   **Offline Storage:**  for caching data like user sessions, survey data, and queued location updates.
-   **State Management:** React Context API for managing authentication () and survey data ().
-   **API Communication:**  for making HTTP requests to the FastAPI backend.
</key_technical_concepts>

<code_architecture>
The project is a monorepo with , , and  directories.

**Directory Structure:**


-   ****
    -   **Importance:** The core of the backend. It defines all API endpoints, data models (Pydantic), and business logic for user management, authentication, and data handling for surveys, respondents, and locations.
    -   **Changes:** Initially a simple server, it was significantly expanded to include JWT security, CRUD operations for multiple surveys, respondents, and users, and role-based data access.
-   ****
    -   **Importance:** The central screen for visualizing field activity. It displays respondents on a map or in a list, allows interaction (zooming, routing), and provides access to add new respondents.
    -   **Changes:** This file has undergone the most changes. It evolved from using the problematic  to a -based Leaflet map. It now includes a list/map view toggle, click-to-zoom, routing functionality, and a header button for adding respondents.
-   ****
    -   **Importance:** A crucial component created to solve map rendering issues in Expo Go. It encapsulates a  that renders a self-contained HTML page with Leaflet.js, receiving location data via props and communicating events back to the React Native app.
    -   **Changes:** Created to replace . It was later enhanced to support props for showing the user's current location, zooming to a specific coordinate, and drawing a route between two points.
-   ****
    -   **Importance:** Defines the main tab navigation for the mobile app, including which screens are visible in the tab bar and their icons.
    -   **Changes:** It was modified to add the  screen and to hide the  screen from the tab bar (), making it a navigable screen but not a main tab.
-   ****
    -   **Importance:** Contains user profile information and the logout functionality.
    -   **Changes:** The logout feature was extensively reworked from a simple  (which failed on Android) to a custom, professionally styled modal that requires a random code for confirmation, improving both functionality and UX.
-   ** & **
    -   **Importance:** These are key data display screens.  shows available surveys, and  shows summary statistics.
    -   **Changes:** Both were recently updated to include a manual synchronization button in the header, along with a Last synced timestamp, to give users control over data freshness.
</code_architecture>

<pending_tasks>
-   **Build Web Leadership Dashboard:** The  is a placeholder. It needs to be developed into a functional React application that consumes the backend API to display real-time progress and location data for leaders.
-   **Integrate Multi-Survey Selection:** The  screen allows users to see surveys, but the selected survey needs to be stored in a global state (e.g., ) and used to filter data across the entire app (Dashboard stats, Map respondents, etc.).
-   **Implement Sync Button Globally:** The sync button has been added to the Dashboard and Survey List. It should be added to other relevant screens like the Map and Chat to ensure a consistent data refresh experience.
</pending_tasks>

<current_work>
The most recent task was implementing a manual synchronization feature. This was in direct response to the user's request for a button for real-time synchronization to the database.

The AI engineer successfully implemented this feature on two key screens:
1.  **:** Added a sync icon button to the header. When pressed, it re-fetches the list of surveys. A Last synced timestamp is displayed to give the user feedback.
2.  **:** A similar sync button and Last synced timestamp were added to the dashboard header to allow users to refresh the survey statistics.

This involved modifying the state management (), adding  functions to re-trigger data loading functions (, ), and updating the  in  to include the new header components. The styles for these new header elements were also added. The final action taken was to restart the Expo server to apply these frontend changes. No summary of this work has been presented to the user yet.
</current_work>

<optional_next_step>
Restart the frontend to apply the changes and then create a summary document explaining the new real-time synchronization feature that has been added to the Dashboard and Surveys List screens.
</optional_next_step>
